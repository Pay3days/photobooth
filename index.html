<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PhotoBooth</title>
<link rel="manifest" href="manifest.json">
<style>
*{box-sizing:border-box;margin:0;padding:0}
body{background:#0f0f1a;color:#eaeaea;font-family:sans-serif;width:100%;height:100vh;overflow:hidden}
.screen{display:none;position:fixed;top:0;left:0;width:100%;height:100%;align-items:center;justify-content:center;flex-direction:column}
.screen.active{display:flex}
.screen-content{padding:40px 24px;max-width:780px;width:100%;text-align:center}
.screen-content.wide{max-width:1140px}
h2{font-size:1.8rem;margin-bottom:8px;color:#eaeaea}
.subtitle{color:rgba(234,234,234,.5);margin-bottom:28px;font-size:.95rem}
.logo{font-size:5rem;line-height:1;margin-bottom:10px}
.app-title{font-size:3.2rem;font-weight:900;color:#e94560;margin-bottom:10px}
.count-grid{display:flex;gap:24px;justify-content:center;flex-wrap:wrap;margin-top:8px}
.count-btn{background:#16213e;border:3px solid rgba(255,255,255,.08);border-radius:14px;padding:24px 20px;cursor:pointer;color:#eaeaea;display:flex;flex-direction:column;align-items:center;gap:10px;min-width:175px}
.count-btn:hover,.count-btn.active{border-color:#e94560}
.count-btn strong{font-size:1.1rem}
.count-btn small{color:rgba(234,234,234,.5);font-size:.78rem}
.count-preview{display:grid;gap:5px;width:100px;height:100px}
.count-preview span{background:rgba(255,255,255,.18);border-radius:4px;display:block}
.c2.r2{grid-template-columns:1fr 1fr;grid-template-rows:1fr 1fr}
.c2.r3{grid-template-columns:1fr 1fr;grid-template-rows:1fr 1fr 1fr}
.c2.r4{grid-template-columns:1fr 1fr;grid-template-rows:1fr 1fr 1fr 1fr}
.tpl-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:18px;margin-bottom:28px;max-height:56vh;overflow-y:auto}
.tpl-card{background:#16213e;border:3px solid rgba(255,255,255,.08);border-radius:14px;overflow:hidden;cursor:pointer}
.tpl-card:hover,.tpl-card.sel{border-color:#e94560}
.tpl-card canvas{display:block;width:100%}
.tpl-name{padding:10px;font-size:.9rem;font-weight:600;text-align:center}
.cam-wrap{position:fixed;top:0;left:0;width:100%;height:100%;background:#000;display:flex;flex-direction:column;overflow:hidden}
#cam-video{flex:1;width:100%;max-height:calc(100vh - 110px);object-fit:cover;display:block}
.cnt-overlay{position:absolute;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.4);display:flex;align-items:center;justify-content:center;z-index:10}
.cnt-overlay.hidden{display:none}
#cnt-ring{position:relative;width:190px;height:190px}
#cnt-ring svg{width:190px;height:190px;transform:rotate(-90deg)}
.ring-bg{fill:none;stroke:rgba(255,255,255,.15);stroke-width:10}
.ring-fg{fill:none;stroke:#e94560;stroke-width:10;stroke-dasharray:339;stroke-dashoffset:0;stroke-linecap:round;transition:stroke-dashoffset .92s linear}
#cnt-num{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:5.5rem;font-weight:900;color:#fff}
.cam-flash{position:absolute;top:0;left:0;width:100%;height:100%;background:#fff;opacity:0;pointer-events:none;z-index:20}
.cam-flash.go{animation:flash .35s ease forwards}
@keyframes flash{0%{opacity:0}40%{opacity:1}100%{opacity:0}}
.cam-hud{background:rgba(8,8,18,.95);padding:10px 16px;height:110px;height:auto;flex-shrink:0;display:flex;align-items:center;gap:16px;z-index:50;position:relative}
.strip-wrap{flex:1;overflow:hidden}
.photo-strip{display:flex;gap:8px;overflow-x:auto;padding-bottom:4px}
.photo-strip .thumb{width:88px;height:66px;object-fit:cover;border-radius:7px;border:2px solid transparent;flex-shrink:0}
.thumb.latest{border-color:#e94560}
.hud-status{text-align:center;min-width:200px;display:flex;flex-direction:column;align-items:center;gap:9px}
#cap-label{font-size:.82rem;color:#f5a623;font-weight:700}
.prog-bar{width:100%;height:5px;background:rgba(255,255,255,.1);border-radius:3px;overflow:hidden}
.prog-fill{height:100%;background:#e94560;border-radius:3px;width:0%}
.sel-header{display:flex;align-items:center;justify-content:space-between;gap:20px;margin-bottom:22px;text-align:left}
.sel-timer-box{position:relative;width:80px;height:80px;flex-shrink:0}
.sel-svg{width:80px;height:80px;transform:rotate(-90deg)}
.sel-bg{fill:none;stroke:rgba(255,255,255,.1);stroke-width:9}
.sel-fg{fill:none;stroke:#e94560;stroke-width:9;stroke-dasharray:214;stroke-dashoffset:0;stroke-linecap:round;transition:stroke-dashoffset 1s linear}
#sel-secs{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:1.4rem;font-weight:700;color:#e94560}
.sel-grid{display:grid;grid-template-columns:repeat(5,1fr);gap:14px}
.sel-item{position:relative;cursor:pointer;border-radius:10px;overflow:hidden;border:3px solid transparent;aspect-ratio:4/3}
.sel-item img{width:100%;height:100%;object-fit:cover;display:block}
.sel-item.sel{border-color:#e94560}
.sel-badge{display:none;position:absolute;top:6px;right:6px;width:28px;height:28px;background:#e94560;border-radius:50%;align-items:center;justify-content:center;font-size:.78rem;font-weight:700}
.sel-item.sel .sel-badge{display:flex}
.prev-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:22px;margin-top:24px}
.prev-card{background:#16213e;border-radius:14px;padding:20px;display:flex;flex-direction:column;align-items:center;gap:14px}
.prev-card h3{color:#f5a623;font-size:.95rem}
.prev-img{width:100%;background:#000;border-radius:10px;max-height:300px;overflow:hidden;display:flex;align-items:center;justify-content:center}
.prev-img canvas,.prev-img img{max-width:100%;max-height:300px;object-fit:contain}
.qr-box{background:#fff;border-radius:12px;padding:12px;display:flex;align-items:center;justify-content:center}
.qr-url{font-size:.68rem;color:rgba(234,234,234,.5);word-break:break-all;max-width:230px}
.btn-pri{background:#e94560;color:#fff;border:none;padding:13px 30px;border-radius:50px;font-size:1rem;font-weight:700;cursor:pointer}
.btn-pri:disabled{opacity:.4;cursor:not-allowed}
.btn-lg{padding:16px 42px;font-size:1.1rem}
.btn-sec{background:#16213e;color:#eaeaea;border:2px solid rgba(255,255,255,.08);padding:13px 30px;border-radius:50px;font-size:1rem;font-weight:600;cursor:pointer}
.btn-ghost{background:rgba(255,255,255,.07);color:#eaeaea;border:1px solid rgba(255,255,255,.08);padding:8px 20px;border-radius:20px;font-size:.88rem;cursor:pointer}
.row-actions{display:flex;gap:14px;justify-content:center;flex-wrap:wrap}
.loading{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(15,15,26,.95);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:9999}
.loading.hidden{display:none}
.spinner{width:54px;height:54px;border:5px solid rgba(233,69,96,.18);border-top-color:#e94560;border-radius:50%;animation:spin 1s linear infinite;margin-bottom:18px}
@keyframes spin{to{transform:rotate(360deg)}}
#load-msg{color:rgba(234,234,234,.5);font-size:1.05rem}
</style>
</head>
<body>

<div id="screen-welcome" class="screen active">
  <div class="screen-content">
    <div class="logo">ðŸ“¸</div>
    <h1 class="app-title">PhotoBooth</h1>
    <p class="subtitle">How many photos in your layout?</p>
    <div class="count-grid">
      <button class="count-btn" data-count="4">
        <div class="count-preview c2 r2"><span></span><span></span><span></span><span></span></div>
        <strong>4 Photos</strong><small>2 x 2</small>
      </button>
      <button class="count-btn" data-count="6">
        <div class="count-preview c2 r3"><span></span><span></span><span></span><span></span><span></span><span></span></div>
        <strong>6 Photos</strong><small>2 x 3</small>
      </button>
      <button class="count-btn" data-count="8">
        <div class="count-preview c2 r4"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></div>
        <strong>8 Photos</strong><small>2 x 4</small>
      </button>
    </div>
  </div>
</div>

<div id="screen-template" class="screen">
  <div class="screen-content wide">
    <h2>Choose a Template Style</h2>
    <p class="subtitle">Select a design for your photo layout</p>
    <div class="tpl-grid" id="tpl-grid"></div>
    <div class="row-actions">
      <button id="btn-back-w" class="btn-sec">Back</button>
      <button id="btn-go-cam" class="btn-pri" disabled>Open Camera</button>
    </div>
  </div>
</div>

<div id="screen-camera" class="screen">
  <div class="cam-wrap">
    <video id="cam-video" autoplay playsinline muted></video>
    <canvas id="cap-canvas" style="display:none"></canvas>
    <div id="cnt-overlay" class="cnt-overlay hidden">
      <div id="cnt-ring">
        <svg viewBox="0 0 120 120">
          <circle cx="60" cy="60" r="54" class="ring-bg"/>
          <circle cx="60" cy="60" r="54" class="ring-fg" id="cnt-ring-fg"/>
        </svg>
        <span id="cnt-num">3</span>
      </div>
    </div>
    <div id="cam-flash" class="cam-flash"></div>
    <div class="cam-hud">
      <div class="strip-wrap"><div class="photo-strip" id="photo-strip"></div></div>
      <div class="hud-status">
        <span id="cap-label">Ready</span>
        <div class="prog-bar"><div class="prog-fill" id="prog-fill"></div></div>
        <button id="btn-start-cap" class="btn-pri btn-lg">Start (10 photos)</button>
      </div>
    </div>
  </div>
</div>

<div id="screen-select" class="screen">
  <div class="screen-content wide">
    <div class="sel-header">
      <div>
        <h2>Select <span id="req-count">4</span> Photos</h2>
        <p class="subtitle">Tap to pick. Auto-fills when timer ends.</p>
      </div>
      <div class="sel-timer-box">
        <svg class="sel-svg" viewBox="0 0 80 80">
          <circle cx="40" cy="40" r="34" class="sel-bg"/>
          <circle cx="40" cy="40" r="34" class="sel-fg" id="sel-fg"/>
        </svg>
        <span id="sel-secs">60</span>
      </div>
    </div>
    <div class="sel-grid" id="sel-grid"></div>
    <div class="row-actions" style="margin-top:22px">
      <button id="btn-confirm" class="btn-pri btn-lg" disabled>Confirm</button>
    </div>
  </div>
</div>

<div id="screen-preview" class="screen">
  <div class="screen-content wide">
    <h2>Your Photos Are Ready!</h2>
    <div class="prev-grid">
      <div class="prev-card">
        <h3>Template Photo</h3>
        <div class="prev-img"><canvas id="tpl-out"></canvas></div>
        <button class="btn-ghost" onclick="downloadTemplate()">Download</button>
      </div>
      <div class="prev-card">
        <h3>GIF Animation</h3>
        <div class="prev-img"><img id="gif-out" alt="GIF"></div>
        <button class="btn-ghost" onclick="downloadGif()">Download GIF</button>
      </div>
      <div class="prev-card">
        <h3>Scan QR Code</h3>
        <div id="qr-out" class="qr-box"></div>
        <p id="qr-url" class="qr-url"></p>
      </div>
    </div>
    <div class="row-actions" style="margin-top:28px">
      <button id="btn-print" class="btn-pri btn-lg">Print</button>
      <button id="btn-new" class="btn-sec">New Session</button>
    </div>
  </div>
</div>

<div id="loading" class="loading hidden">
  <div class="spinner"></div>
  <p id="load-msg">Processing...</p>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/gif.js@0.2.0/dist/gif.min.js"></script>
<script>
const IMGBB_KEY = 'f4b3c48a50c7abd0c5abbe94f82250fe';
const S = {count:4,template:null,photos:[],selected:[],gifDataUrl:null,workerUrl:null,timerHandle:null};
const TEMPLATES = [
  {id:'classic',name:'Classic',bg:'#ffffff',fg:'#222222',frame:'#cccccc'},
  {id:'dark',name:'Modern Dark',bg:'#1a1a2e',fg:'#e94560',frame:'#e94560'},
  {id:'vintage',name:'Vintage',bg:'#f5e6c8',fg:'#8B4513',frame:'#a0522d'},
  {id:'neon',name:'Neon Night',bg:'#050510',fg:'#00ff87',frame:'#00ff87'},
  {id:'pastel',name:'Pastel Dream',bg:'#fce4ec',fg:'#d81b60',frame:'#f48fb1'},
  {id:'gold',name:'Gold Luxury',bg:'#111111',fg:'#ffd700',frame:'#ffd700'},
];
const $ = id => document.getElementById(id);
const sc = {welcome:$('screen-welcome'),template:$('screen-template'),camera:$('screen-camera'),select:$('screen-select'),preview:$('screen-preview')};
const sleep = ms => new Promise(r => setTimeout(r,ms));

function show(name){Object.values(sc).forEach(s=>s.classList.remove('active'));sc[name].classList.add('active');}
function loading(msg){if(msg){$('load-msg').textContent=msg;$('loading').classList.remove('hidden')}else{$('loading').classList.add('hidden')}}
function loadImg(src){return new Promise((res,rej)=>{const i=new Image();i.crossOrigin='anonymous';i.onload=()=>res(i);i.onerror=rej;i.src=src;});}
function roundRect(ctx,x,y,w,h,r){ctx.beginPath();ctx.moveTo(x+r,y);ctx.arcTo(x+w,y,x+w,y+h,r);ctx.arcTo(x+w,y+h,x,y+h,r);ctx.arcTo(x,y+h,x,y,r);ctx.arcTo(x,y,x+w,y,r);ctx.closePath();}
function drawCover(ctx,img,x,y,w,h){const s=Math.max(w/img.width,h/img.height);ctx.drawImage(img,x+(w-img.width*s)/2,y+(h-img.height*s)/2,img.width*s,img.height*s);}

(async()=>{try{const blob=await fetch('https://cdn.jsdelivr.net/npm/gif.js@0.2.0/dist/gif.worker.js').then(r=>r.blob());S.workerUrl=URL.createObjectURL(blob);}catch(e){console.warn('GIF worker preload failed',e);}})();

document.querySelectorAll('.count-btn').forEach(btn=>{
  btn.addEventListener('click',()=>{
    document.querySelectorAll('.count-btn').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');S.count=parseInt(btn.dataset.count);
    $('req-count').textContent=S.count;buildTplGrid();setTimeout(()=>show('template'),300);
  });
});

function buildTplGrid(){
  const grid=$('tpl-grid');grid.innerHTML='';S.template=null;$('btn-go-cam').disabled=true;
  TEMPLATES.forEach(tpl=>{
    const card=document.createElement('div');card.className='tpl-card';
    const cvs=document.createElement('canvas');cvs.width=200;cvs.height=270;
    drawTplPreview(cvs,tpl,S.count);
    const lbl=document.createElement('div');lbl.className='tpl-name';lbl.textContent=tpl.name;
    card.append(cvs,lbl);
    card.addEventListener('click',()=>{document.querySelectorAll('.tpl-card').forEach(c=>c.classList.remove('sel'));card.classList.add('sel');S.template=tpl;$('btn-go-cam').disabled=false;});
    grid.appendChild(card);
  });
}
function drawTplPreview(canvas,tpl,count){
  const ctx=canvas.getContext('2d');const W=canvas.width,H=canvas.height;
  const PAD=10,HDR=34,cols=2,rows=Math.ceil(count/cols);
  const cW=(W-PAD*(cols+1))/cols;const cH=(H-PAD*(rows+1)-HDR-20)/rows;
  ctx.fillStyle=tpl.bg;ctx.fillRect(0,0,W,H);
  ctx.fillStyle=tpl.fg;ctx.font='bold 12px sans-serif';ctx.textAlign='center';ctx.textBaseline='middle';
  ctx.fillText('Photo Booth',W/2,18);
  for(let i=0;i<count;i++){
    const col=i%cols,row=Math.floor(i/cols);const x=PAD+col*(cW+PAD),y=HDR+PAD+row*(cH+PAD);
    ctx.fillStyle=tpl.fg+'22';roundRect(ctx,x,y,cW,cH,6);ctx.fill();
    ctx.strokeStyle=tpl.frame;ctx.lineWidth=1.5;roundRect(ctx,x,y,cW,cH,6);ctx.stroke();
  }
}
$('btn-back-w').addEventListener('click',()=>show('welcome'));
$('btn-go-cam').addEventListener('click',async()=>{await initCamera();show('camera');});

let mediaStream=null;
async function initCamera(){
  if(mediaStream)return;
  try{mediaStream=await navigator.mediaDevices.getUserMedia({video:{facingMode:'user',width:{ideal:1920},height:{ideal:1080}},audio:false});$('cam-video').srcObject=mediaStream;await $('cam-video').play();}
  catch(err){alert('Camera access denied. Allow camera in browser settings.');}
}
$('btn-start-cap').addEventListener('click',()=>startCapture());
async function startCapture(){
  S.photos=[];$('photo-strip').innerHTML='';$('btn-start-cap').disabled=true;$('prog-fill').style.width='0%';
  for(let i=0;i<10;i++){$('cap-label').textContent=`Photo ${i+1} of 10`;await runCountdown(3);captureFrame(i);$('prog-fill').style.width=`${(i+1)*10}%`;await sleep(400);}
  $('cap-label').textContent='Done! 10 photos taken';$('btn-start-cap').disabled=false;
  setTimeout(()=>{buildSelectionScreen();show('select');},700);
}
async function runCountdown(from){
  const overlay=$('cnt-overlay'),numEl=$('cnt-num'),ringEl=$('cnt-ring-fg'),circum=339;
  overlay.classList.remove('hidden');
  for(let n=from;n>=1;n--){numEl.textContent=n;ringEl.style.strokeDashoffset=circum*(1-n/from);await sleep(950);}
  overlay.classList.add('hidden');ringEl.style.strokeDashoffset=0;
}
function captureFrame(idx){
  const video=$('cam-video'),canvas=$('cap-canvas');
  canvas.width=video.videoWidth||1280;canvas.height=video.videoHeight||720;
  canvas.getContext('2d').drawImage(video,0,0);
  const url=canvas.toDataURL('image/jpeg',.92);S.photos.push(url);
  const flash=$('cam-flash');flash.classList.add('go');setTimeout(()=>flash.classList.remove('go'),350);
  const img=document.createElement('img');img.src=url;img.className='thumb latest';
  $('photo-strip').appendChild(img);img.scrollIntoView({behavior:'smooth',inline:'end'});
  setTimeout(()=>img.classList.remove('latest'),600);
}

function buildSelectionScreen(){
  const grid=$('sel-grid');grid.innerHTML='';S.selected=[];$('btn-confirm').disabled=true;
  S.photos.forEach((url,idx)=>{
    const item=document.createElement('div');item.className='sel-item';item.dataset.idx=idx;
    const img=document.createElement('img');img.src=url;img.alt=`Photo ${idx+1}`;
    const badge=document.createElement('div');badge.className='sel-badge';
    item.append(img,badge);item.addEventListener('click',()=>toggleSel(item,idx));grid.appendChild(item);
  });startSelTimer();
}
function toggleSel(item,idx){
  if(item.classList.contains('sel')){item.classList.remove('sel');S.selected=S.selected.filter(i=>i!==idx);}
  else{if(S.selected.length>=S.count){const oldIdx=S.selected.shift();document.querySelector(`.sel-item[data-idx="${oldIdx}"]`).classList.remove('sel');}item.classList.add('sel');S.selected.push(idx);}
  document.querySelectorAll('.sel-item').forEach(el=>{const pos=S.selected.indexOf(parseInt(el.dataset.idx));el.querySelector('.sel-badge').textContent=pos>=0?pos+1:'';});
  $('btn-confirm').disabled=S.selected.length!==S.count;
}
function startSelTimer(){
  clearInterval(S.timerHandle);let left=60;const circum=214;$('sel-secs').textContent=left;$('sel-fg').style.strokeDashoffset=0;
  S.timerHandle=setInterval(()=>{left--;$('sel-secs').textContent=left;$('sel-fg').style.strokeDashoffset=circum*(1-left/60);if(left<=0){clearInterval(S.timerHandle);autoFillAndProceed();}},1000);
}
function autoFillAndProceed(){
  if(S.selected.length<S.count){const unsel=S.photos.map((_,i)=>i).filter(i=>!S.selected.includes(i));while(S.selected.length<S.count&&unsel.length){const idx=unsel.shift();S.selected.push(idx);document.querySelector(`.sel-item[data-idx="${idx}"]`)?.classList.add('sel');}}
  proceedToPreview();
}
$('btn-confirm').addEventListener('click',()=>{clearInterval(S.timerHandle);proceedToPreview();});

async function proceedToPreview(){
  try{
    loading('Composing template photo...');const tplCanvas=await composeTemplate();
    const out=$('tpl-out');out.width=tplCanvas.width;out.height=tplCanvas.height;out.getContext('2d').drawImage(tplCanvas,0,0);
    loading('Generating GIF...');S.gifDataUrl=await makeGIF();$('gif-out').src=S.gifDataUrl;
    loading('Generating QR code...');await uploadAndQR(tplCanvas);
    loading(false);show('preview');
  }catch(err){loading(false);console.error(err);alert('Error: '+err.message);}
}
async function composeTemplate(){
  const tpl=S.template,count=S.count,photos=S.selected.map(i=>S.photos[i]);
  const W=1200,cols=2,rows=Math.ceil(count/cols),HDR=90,FTR=50,PAD=36;
  const cW=(W-PAD*(cols+1))/cols,cH=Math.round(cW*.75);
  const H=HDR+PAD+rows*cH+(rows-1)*PAD+PAD+FTR;
  const canvas=document.createElement('canvas');canvas.width=W;canvas.height=H;
  const ctx=canvas.getContext('2d');
  ctx.fillStyle=tpl.bg;ctx.fillRect(0,0,W,H);
  ctx.font='bold 42px sans-serif';ctx.fillStyle=tpl.fg;ctx.textAlign='center';ctx.textBaseline='middle';ctx.fillText('Photo Booth',W/2,HDR/2);
  const imgs=await Promise.all(photos.map(loadImg));
  for(let i=0;i<count&&i<imgs.length;i++){
    const col=i%cols,row=Math.floor(i/cols);const x=PAD+col*(cW+PAD),y=HDR+PAD+row*(cH+PAD);
    ctx.save();roundRect(ctx,x,y,cW,cH,14);ctx.clip();drawCover(ctx,imgs[i],x,y,cW,cH);ctx.restore();
    ctx.strokeStyle=tpl.frame;ctx.lineWidth=3;roundRect(ctx,x,y,cW,cH,14);ctx.stroke();
  }
  const date=new Date().toLocaleDateString('en-US',{year:'numeric',month:'long',day:'numeric'});
  ctx.font='26px sans-serif';ctx.fillStyle=tpl.fg+'aa';ctx.textAlign='center';ctx.textBaseline='bottom';ctx.fillText(date,W/2,H-14);
  return canvas;
}
async function makeGIF(){
  return new Promise(async(resolve,reject)=>{
    const gif=new GIF({workers:2,quality:12,width:640,height:480,workerScript:S.workerUrl||'https://cdn.jsdelivr.net/npm/gif.js@0.2.0/dist/gif.worker.js'});
    const tmp=document.createElement('canvas');tmp.width=640;tmp.height=480;const ctx=tmp.getContext('2d');
    const imgs=await Promise.all(S.photos.map(loadImg));
    imgs.forEach(img=>{ctx.fillStyle='#000';ctx.fillRect(0,0,640,480);drawCover(ctx,img,0,0,640,480);gif.addFrame(tmp,{copy:true,delay:450});});
    gif.on('finished',blob=>{const reader=new FileReader();reader.onload=()=>resolve(reader.result);reader.readAsDataURL(blob);});
    gif.on('error',reject);gif.render();
  });
}
async function uploadAndQR(tplCanvas){
  const qrBox=$('qr-out');qrBox.innerHTML='';
  try{
    if(!IMGBB_KEY||IMGBB_KEY==='PASTE_YOUR_KEY_HERE')throw new Error('No API key');
    const b64=tplCanvas.toDataURL('image/jpeg',.88).split(',')[1];const form=new FormData();form.append('image',b64);
    const res=await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_KEY}`,{method:'POST',body:form});
    const data=await res.json();if(!data.success)throw new Error('Upload failed');
    const url=data.data.display_url;
    new QRCode(qrBox,{text:url,width:200,height:200,colorDark:'#000',colorLight:'#fff',correctLevel:QRCode.CorrectLevel.H});
    $('qr-url').textContent=url;
  }catch(err){
    console.warn('ImgBB:',err.message);
    new QRCode(qrBox,{text:`PhotoBooth-${Date.now()}`,width:200,height:200});
    $('qr-url').textContent='Download photos using buttons below';
  }
}
function downloadTemplate(){const link=document.createElement('a');link.download=`photobooth_${Date.now()}.jpg`;link.href=$('tpl-out').toDataURL('image/jpeg',.95);link.click();}
function downloadGif(){const link=document.createElement('a');link.download=`photobooth_gif_${Date.now()}.gif`;link.href=S.gifDataUrl;link.click();}
$('btn-print').addEventListener('click',()=>{
  const imgSrc=$('tpl-out').toDataURL('image/jpeg',.95);const pw=window.open('','_blank');
  pw.document.write(`<!DOCTYPE html><html><head><style>*{margin:0;padding:0}body{display:flex;justify-content:center;align-items:center;min-height:100vh}img{max-width:100%}@media print{img{width:100%}}</style></head><body><img src="${imgSrc}" onload="setTimeout(()=>{window.print();window.close();},300)"></body></html>`);
  pw.document.close();
});
$('btn-new').addEventListener('click',()=>{
  clearInterval(S.timerHandle);if(mediaStream){mediaStream.getTracks().forEach(t=>t.stop());mediaStream=null;}
  Object.assign(S,{count:4,template:null,photos:[],selected:[],gifDataUrl:null});
  $('photo-strip').innerHTML='';$('sel-grid').innerHTML='';$('qr-out').innerHTML='';$('qr-url').textContent='';
  $('prog-fill').style.width='0%';$('cap-label').textContent='Ready';
  document.querySelectorAll('.count-btn').forEach(b=>b.classList.remove('active'));
  $('btn-go-cam').disabled=true;show('welcome');
});
</script>
</body>
</html>



